name: Release application

on:
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: dwk-cluster
  GKE_ZONE: southamerica-east1-a # SÃ£o Paulo  
  REGISTRY: southamerica-east1-docker.pkg.dev # https://cloud.google.com/artifact-registry/docs/repositories/repo-locations
  REPOSITORY: dwk-repo
  BRANCH: ${{ github.ref_name }}

jobs:
  build-todo-app:
    if: false
    name: Build & Publish "todo-app" to GKE
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - uses: 'google-github-actions/auth@v3'
        with:
          credentials_json: '${{ secrets.GKE_SA_KEY }}' 

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v3'
        with:
          version: '>= 363.0.0'
      
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: 'Build and push'
        run: |
          IMAGE_TAG=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/todo-app:$BRANCH-$GITHUB_SHA
          docker build -t $IMAGE_TAG ./project/todo-app
          docker push $IMAGE_TAG

  build-todo-backend:
    if: false
    name: Build & Publish "todo-backend" to GKE
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - uses: 'google-github-actions/auth@v3'
        with:
          credentials_json: '${{ secrets.GKE_SA_KEY }}' 

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v3'
        with:
          version: '>= 363.0.0'

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGISTRY }}
 
      - name: 'Build and push'
        run: |
          IMAGE_TAG=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/todo-backend:$BRANCH-$GITHUB_SHA
          docker build -t $IMAGE_TAG ./project/todo-backend
          docker push $IMAGE_TAG
  
  deploy-to-cluster:
    name: Deploy to GKE cluster using Kustomize
    runs-on: ubuntu-latest

    needs:
      - build-todo-app
      - build-todo-backend

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - uses: 'google-github-actions/auth@v3'
        with:
          credentials_json: '${{ secrets.GKE_SA_KEY }}' 

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v3'
        with:
          version: '>= 363.0.0'

      - name: 'Use gcloud CLI'
        run: 'gcloud info'

      - name: 'Get GKE credentials'
        uses: 'google-github-actions/get-gke-credentials@v3'
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}
          project_id: ${{ env.PROJECT_ID }}
      
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2.1.0

      - name: Deploy to GKE with Kustomize
        run: |
          # Determine namespace based on branch
          if [ "$BRANCH" = "main" ]; then 
            NAMESPACE="project";
          else 
            NAMESPACE="$BRANCH";
          fi

          # Reconstruct image tags
          IMAGE_TAG_APP=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/todo-app:$BRANCH-$GITHUB_SHA
          IMAGE_TAG_BACKEND=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/todo-backend:$BRANCH-$GITHUB_SHA
          
          # Go to project directory
          cd project

          # Create namespace if not exists
          kubectl create namespace $NAMESPACE || true
          kubectl config set-context --current --namespace=$NAMESPACE

          # Update kustomization.yaml
          kustomize version
          kustomize edit set namespace $NAMESPACE
          kustomize edit set image lucksei/todo-app=$IMAGE_TAG_APP
          kustomize edit set image lucksei/todo-backend=$IMAGE_TAG_BACKEND
          
          # Deploy to GKE
          kustomize build . | kubectl apply -f -
