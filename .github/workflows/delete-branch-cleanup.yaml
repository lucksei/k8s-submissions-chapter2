name: Branch Deletion Cleanup

on:
  delete:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: dwk-cluster
  GKE_ZONE: southamerica-east1-a # SÃ£o Paulo  
  REGISTRY: southamerica-east1-docker.pkg.dev # https://cloud.google.com/artifact-registry/docs/repositories/repo-locations
  REPOSITORY: dwk-repo

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - uses: 'google-github-actions/auth@v3'
        with:
          credentials_json: '${{ secrets.GKE_SA_KEY }}' 

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v3'
        with:
          version: '>= 363.0.0'

      - name: 'Use gcloud CLI'
        run: 'gcloud info'

      - name: 'Get GKE credentials'
        uses: 'google-github-actions/get-gke-credentials@v3'
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Determine namespace and cleanup
        run: |
          # Get the branch name from the delete event
          BRANCH="${{ github.event.ref }}"
          # Remove 'refs/heads/' prefix if present
          BRANCH="${BRANCH#refs/heads/}"
          echo "Branch deleted: $BRANCH"
      
      - name: Delete namespace
        run: |
          # Determine namespace based on branch
          if [ "$BRANCH" = "main" ]; then 
            NAMESPACE="project";
          else 
            NAMESPACE="$BRANCH";
          fi

          kubectl delete namespace $NAMESPACE || echo "Namespace $NAMESPACE does not exist or has already been deleted."